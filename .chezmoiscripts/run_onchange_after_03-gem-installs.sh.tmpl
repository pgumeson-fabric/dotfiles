#! /usr/bin/env zsh

{{ template "printers.zsh" }}

_print_running_script "$0"

set -euo pipefail

## Gemfile: {{ include "Gemfile.tmpl" | sha256sum }}

if ! command -v pkgx &> /dev/null; then
  _print_error "pkgx not installed"
  exit 1
fi

# rubygems
echo
_print_prog gem "update --system"
pkgx gem update --system

echo
_print_info "using gem $(pkgx gem -v)"

echo
_print_prog gem "install bundler"
pkgx gem install --user-install --silent --no-document --bindir "$HOME/.gem/bin" bundler

echo
_print_prog bundle "update --bundler"
pkgx bundle update --bundler

# Install default gems
echo
_print_info "using $(pkgx bundle -v)"

echo
_print_prog bundle "install with: $(pkgx ruby -v)"
pkgx bundle install --gemfile="$HOME/Gemfile"

echo
_print_prog bundle "binstubs --all"
pkgx bundle binstubs --all --force --path="$HOME/.gem/bin"
_print_prog bundle "config --delete bin"
pkgx bundle config --delete bin


echo
_print_ok
